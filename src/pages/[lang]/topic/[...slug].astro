---
import { getCollection } from 'astro:content';
import { supportedLocales } from '~/i18n/config';
import Layout from '~/layouts/PageLayout.astro';
import i18n from '~/utils/i18n';


export async function getStaticPaths() {
  const pages = await getCollection('topic');

  // Group pages by their base slug (without language)
  const pagesBySlug = {};
  
  // Build the pagesBySlug object
  for (const page of pages) {
    const [lang, ...slugParts] = page.slug.split('/');
    const baseSlug = slugParts.join('/');
    
    if (!pagesBySlug[baseSlug]) {
      pagesBySlug[baseSlug] = {};
    }
    pagesBySlug[baseSlug][lang] = page;
  }
  
  return Object.keys(pagesBySlug).flatMap((baseSlug) => {
    const langPages = pagesBySlug[baseSlug];
    const availableLanguages = Object.keys(langPages);

    // Use the first available language as fallback
    const fallbackPage = langPages[availableLanguages[0]];
    
    // Generate paths for supported languages
    const supportedLangs = supportedLocales;
   
    return supportedLangs.map((lang) => {
      const page = langPages[lang] || fallbackPage;
      return {
        params: { 
          lang,
          slug: baseSlug || undefined 
        },
        props: { 
          page,
          isFallback: !langPages[lang],
          fallbackLang: !langPages[lang] ? fallbackPage.slug.split('/')[0] : null
        }
      };
    });
  });
}

const { lang = 'fa', slug } = Astro.params;
const { page, isFallback, fallbackLang } = Astro.props;
const pageData = page.data;

const { Content } = await page.render();

const metadata = {
  title: 'Persin Flutter',
  ignoreTitleTemplate: true,
};

i18n.setLang(lang);
---

<Layout metadata={metadata}>
  <h1>Language: {lang}</h1>
  <h1>isFallback: {isFallback}</h1>
  <h1>fallbackLang: {fallbackLang}</h1>
  <h2>Astro preferredLocaleList: {Astro.preferredLocaleList}</h2>
  <h2>Astro preferredLocaleList: {JSON.stringify(Astro.locals)}</h2>
  <h2>Slug: {slug}</h2>
  <p>Name: {slug}</p>
  <p>Page Data: {JSON.stringify(pageData)}</p>
  <Content />
</Layout>

